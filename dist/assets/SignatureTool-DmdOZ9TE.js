import{r as u,j as n}from"./index-D_qvBJzx.js";import{P as V}from"./PDFButton-D8tUxpMY.js";import{p as P}from"./pdf-CB4NDRGm.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";try{P.GlobalWorkerOptions.workerSrc=`//cdnjs.cloudflare.com/ajax/libs/pdf.js/${P.version}/pdf.worker.min.js`}catch{}function q({ov:p,onDrag:k,onStartDrag:h,onStartResize:D}){return n.jsxs("div",{className:"sig-overlay",style:{left:p.x,top:p.y,width:p.w,height:p.h},onMouseDown:h,children:[n.jsx("img",{src:p.dataUrl,className:"sig-image",alt:"sig"}),n.jsx("div",{className:"sig-resize",onMouseDown:D})]})}function te(){const[p,k]=u.useState(null),[h,D]=u.useState([]),[y,O]=u.useState(null),[m,x]=u.useState([]),[R,C]=u.useState(null),j=u.useRef([]),[U,M]=u.useState(!1),W=u.useRef(null),w=u.useRef(null);u.useEffect(()=>{function t(a){if(!w.current)return;const{type:s,idx:i,startX:l,startY:c,startW:r,startH:d,page:o}=w.current,v=a.clientX-l,b=a.clientY-c;x(S=>{const g=S.slice(),f={...g[i]};return s==="move"?(f.x=Math.max(0,l+v-g[`_pageOffset${o}`]),f.y=Math.max(0,c+b-g[`_pageOffsetY${o}`])):s==="resize"&&(f.w=Math.max(10,r+v),f.h=Math.max(10,d+b)),g[i]=f,g})}function e(){w.current=null}return window.addEventListener("mousemove",t),window.addEventListener("mouseup",e),()=>{window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e)}},[]);async function F(t){var a;const e=(a=t.target.files)==null?void 0:a[0];e&&(k(e),await N(e))}function z(t){var s;const e=(s=t.target.files)==null?void 0:s[0];if(!e)return;const a=new FileReader;a.onload=()=>O(a.result),a.readAsDataURL(e)}async function N(t){const e=await t.arrayBuffer(),s=await P.getDocument({data:e}).promise,i=[];for(let l=1;l<=s.numPages;l++){const c=await s.getPage(l),r=c.getViewport({scale:1.5}),d=document.createElement("canvas");d.width=Math.floor(r.width),d.height=Math.floor(r.height);const o=d.getContext("2d");await c.render({canvasContext:o,viewport:r}).promise,i.push({canvas:d,width:d.width,height:d.height,viewportWidth:r.width,viewportHeight:r.height})}D(i),x([])}function T(t,e){t.preventDefault();const s=m[e].page,l=h[s].canvas.getBoundingClientRect();x(c=>{const r=c.slice();return r[`_pageOffset${s}`]=l.left,r[`_pageOffsetY${s}`]=l.top,r}),C(e),w.current={type:"move",idx:e,startX:t.clientX,startY:t.clientY,page:s}}function Y(t,e){t.preventDefault();const a=m[e];w.current={type:"resize",idx:e,startX:t.clientX,startY:t.clientY,startW:a.w,startH:a.h}}function B(t){if(!y)return alert("Create or upload a signature first");const e=h[t];if(!e)return;const a=Math.min(200,e.width*.4),s=Math.min(80,e.height*.15),i=(e.width-a)/2,l=(e.height-s)/2;x(c=>{const r=c.concat({page:t,x:i,y:l,w:a,h:s,dataUrl:y});return j.current.push(c),r})}function _(){R!==null&&(x(t=>{const e=t.slice();return e.splice(R,1),j.current.push(t),e}),C(null))}function H(){const t=j.current.pop();t&&x(t)}async function X(){if(!p)return alert("Select a PDF first");if(m.length===0)return alert("Place a signature before exporting");M(!0);try{const t=await p.arrayBuffer(),e=await V.load(t),a=await(await fetch(y)).arrayBuffer(),s=String(y).startsWith("data:image/jpeg")||String(y).startsWith("data:image/jpg");let i=null;if(s)try{i=await e.embedJpg(a)}catch{i=await e.embedPng(a)}else try{i=await e.embedPng(a)}catch{i=await e.embedJpg(a)}for(const o of m){const v=e.getPages()[o.page],{width:b,height:S}=v.getSize(),g=h[o.page],f=g.width,$=g.height,E=b/f,L=S/$,A=o.x*E,I=S-(o.y+o.h)*L,J=o.w*E,G=o.h*L;v.drawImage(i,{x:A,y:I,width:J,height:G})}const l=await e.save(),c=new Blob([l],{type:"application/pdf"}),r=URL.createObjectURL(c),d=document.createElement("a");d.href=r,d.download=p.name.replace(/\.pdf$/i,"")+"_signed.pdf",d.click(),URL.revokeObjectURL(r)}catch(t){console.error(t),alert("Failed: "+(t.message||t))}finally{M(!1)}}return n.jsxs("div",{children:[n.jsx("h2",{children:"Signature"}),n.jsxs("div",{style:{display:"flex",gap:12,flexWrap:"wrap"},children:[n.jsxs("label",{style:{display:"flex",flexDirection:"column",gap:6},children:["Select PDF",n.jsx("input",{"aria-label":"Select PDF file",type:"file",accept:"application/pdf",onChange:F})]}),n.jsxs("label",{style:{display:"flex",flexDirection:"column",gap:6},children:["Upload signature image",n.jsx("input",{"aria-label":"Upload signature image",type:"file",accept:"image/*",onChange:z})]})]}),n.jsx("div",{style:{marginTop:12},children:n.jsx("div",{className:"muted",children:`Render preview below, then click a page's "Add" to place signature, drag/resize overlay as needed.`})}),n.jsx("div",{ref:W,style:{marginTop:12,display:"flex",flexDirection:"column",gap:18},children:h.map((t,e)=>n.jsxs("div",{style:{position:"relative",border:"1px solid var(--border)",display:"inline-block"},children:[n.jsx("div",{style:{position:"absolute",right:8,top:8,zIndex:10},children:n.jsx("button",{className:"btn-ghost",onClick:()=>B(e),children:"Add"})}),n.jsx("div",{style:{position:"relative"},children:n.jsx("div",{style:{position:"relative"},children:n.jsxs("div",{style:{position:"relative"},children:[n.jsxs("div",{style:{width:t.width,height:t.height},children:[n.jsx("div",{dangerouslySetInnerHTML:{__html:""}}),n.jsx("div",{ref:a=>{a&&!a.firstChild&&a.appendChild(t.canvas)}})]}),m.map((a,s)=>a.page===e?n.jsx(q,{ov:a,onStartDrag:i=>T(i,s),onStartResize:i=>Y(i,s)},s):null)]})})})]},e))}),n.jsxs("div",{style:{marginTop:12,display:"flex",gap:8},children:[n.jsx("button",{className:"btn-primary",onClick:X,disabled:U||!p||m.length===0,children:U?"Working...":"Export Signed PDF"}),n.jsx("button",{className:"btn-ghost",onClick:_,disabled:R===null,children:"Delete"}),n.jsx("button",{className:"btn-ghost",onClick:H,disabled:j.current.length===0,children:"Undo"})]})]})}export{te as default};
