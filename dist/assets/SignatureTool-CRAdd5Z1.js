import{r as u,j as a}from"./index-HKiqIxh0.js";import{P as V}from"./PDFButton-CDUsgRP_.js";import{p as P}from"./pdf-DLgImPGD.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";try{P.GlobalWorkerOptions.workerSrc=`//cdnjs.cloudflare.com/ajax/libs/pdf.js/${P.version}/pdf.worker.min.js`}catch{}function q({ov:p,onDrag:k,onStartDrag:f,onStartResize:D}){return a.jsxs("div",{className:"sig-overlay",style:{position:"absolute",left:p.x,top:p.y,width:p.w,height:p.h,cursor:"move",border:"2px dashed rgba(0,0,0,0.2)",boxSizing:"border-box"},onMouseDown:f,children:[a.jsx("img",{src:p.dataUrl,style:{width:"100%",height:"100%",objectFit:"contain",pointerEvents:"none"},alt:"sig"}),a.jsx("div",{className:"sig-resize",onMouseDown:D,style:{position:"absolute",right:0,bottom:0,width:12,height:12,background:"#fff",border:"1px solid #bbb",cursor:"nwse-resize"}})]})}function te(){const[p,k]=u.useState(null),[f,D]=u.useState([]),[w,F]=u.useState(null),[m,x]=u.useState([]),[R,C]=u.useState(null),b=u.useRef([]),[U,E]=u.useState(!1),L=u.useRef(null),y=u.useRef(null);u.useEffect(()=>{function t(n){if(!y.current)return;const{type:s,idx:i,startX:l,startY:c,startW:r,startH:d,page:o}=y.current,v=n.clientX-l,j=n.clientY-c;x(S=>{const g=S.slice(),h={...g[i]};return s==="move"?(h.x=Math.max(0,l+v-g[`_pageOffset${o}`]),h.y=Math.max(0,c+j-g[`_pageOffsetY${o}`])):s==="resize"&&(h.w=Math.max(10,r+v),h.h=Math.max(10,d+j)),g[i]=h,g})}function e(){y.current=null}return window.addEventListener("mousemove",t),window.addEventListener("mouseup",e),()=>{window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e)}},[]);async function O(t){var n;const e=(n=t.target.files)==null?void 0:n[0];e&&(k(e),await T(e))}function W(t){var s;const e=(s=t.target.files)==null?void 0:s[0];if(!e)return;const n=new FileReader;n.onload=()=>F(n.result),n.readAsDataURL(e)}async function T(t){const e=await t.arrayBuffer(),s=await P.getDocument({data:e}).promise,i=[];for(let l=1;l<=s.numPages;l++){const c=await s.getPage(l),r=c.getViewport({scale:1.5}),d=document.createElement("canvas");d.width=Math.floor(r.width),d.height=Math.floor(r.height);const o=d.getContext("2d");await c.render({canvasContext:o,viewport:r}).promise,i.push({canvas:d,width:d.width,height:d.height,viewportWidth:r.width,viewportHeight:r.height})}D(i),x([])}function Y(t,e){t.preventDefault();const s=m[e].page,l=f[s].canvas.getBoundingClientRect();x(c=>{const r=c.slice();return r[`_pageOffset${s}`]=l.left,r[`_pageOffsetY${s}`]=l.top,r}),C(e),y.current={type:"move",idx:e,startX:t.clientX,startY:t.clientY,page:s}}function B(t,e){t.preventDefault();const n=m[e];y.current={type:"resize",idx:e,startX:t.clientX,startY:t.clientY,startW:n.w,startH:n.h}}function N(t){if(!w)return alert("Create or upload a signature first");const e=f[t];if(!e)return;const n=Math.min(200,e.width*.4),s=Math.min(80,e.height*.15),i=(e.width-n)/2,l=(e.height-s)/2;x(c=>{const r=c.concat({page:t,x:i,y:l,w:n,h:s,dataUrl:w});return b.current.push(c),r})}function _(){R!==null&&(x(t=>{const e=t.slice();return e.splice(R,1),b.current.push(t),e}),C(null))}function H(){const t=b.current.pop();t&&x(t)}async function X(){if(!p)return alert("Select a PDF first");if(m.length===0)return alert("Place a signature before exporting");E(!0);try{const t=await p.arrayBuffer(),e=await V.load(t),n=await(await fetch(w)).arrayBuffer(),s=String(w).startsWith("data:image/jpeg")||String(w).startsWith("data:image/jpg");let i=null;if(s)try{i=await e.embedJpg(n)}catch{i=await e.embedPng(n)}else try{i=await e.embedPng(n)}catch{i=await e.embedJpg(n)}for(const o of m){const v=e.getPages()[o.page],{width:j,height:S}=v.getSize(),g=f[o.page],h=g.width,$=g.height,M=j/h,z=S/$,A=o.x*M,I=S-(o.y+o.h)*z,J=o.w*M,G=o.h*z;v.drawImage(i,{x:A,y:I,width:J,height:G})}const l=await e.save(),c=new Blob([l],{type:"application/pdf"}),r=URL.createObjectURL(c),d=document.createElement("a");d.href=r,d.download=p.name.replace(/\.pdf$/i,"")+"_signed.pdf",d.click(),URL.revokeObjectURL(r)}catch(t){console.error(t),alert("Failed: "+(t.message||t))}finally{E(!1)}}return a.jsxs("div",{children:[a.jsx("h2",{children:"Signature"}),a.jsxs("div",{style:{display:"flex",gap:12,flexWrap:"wrap"},children:[a.jsxs("label",{style:{display:"flex",flexDirection:"column",gap:6},children:["Select PDF",a.jsx("input",{"aria-label":"Select PDF file",type:"file",accept:"application/pdf",onChange:O})]}),a.jsxs("label",{style:{display:"flex",flexDirection:"column",gap:6},children:["Upload signature image",a.jsx("input",{"aria-label":"Upload signature image",type:"file",accept:"image/*",onChange:W})]})]}),a.jsx("div",{style:{marginTop:12},children:a.jsx("div",{className:"muted",children:`Render preview below, then click a page's "Add" to place signature, drag/resize overlay as needed.`})}),a.jsx("div",{ref:L,style:{marginTop:12,display:"flex",flexDirection:"column",gap:18},children:f.map((t,e)=>a.jsxs("div",{style:{position:"relative",border:"1px solid #eee",display:"inline-block"},children:[a.jsx("div",{style:{position:"absolute",right:8,top:8,zIndex:10},children:a.jsx("button",{className:"btn-ghost",onClick:()=>N(e),children:"Add"})}),a.jsx("div",{style:{position:"relative"},children:a.jsx("div",{style:{position:"relative"},children:a.jsxs("div",{style:{position:"relative"},children:[a.jsxs("div",{style:{width:t.width,height:t.height},children:[a.jsx("div",{dangerouslySetInnerHTML:{__html:""}}),a.jsx("div",{ref:n=>{n&&!n.firstChild&&n.appendChild(t.canvas)}})]}),m.map((n,s)=>n.page===e?a.jsx(q,{ov:n,onStartDrag:i=>Y(i,s),onStartResize:i=>B(i,s)},s):null)]})})})]},e))}),a.jsxs("div",{style:{marginTop:12,display:"flex",gap:8},children:[a.jsx("button",{className:"btn-primary",onClick:X,disabled:U||!p||m.length===0,children:U?"Working...":"Export Signed PDF"}),a.jsx("button",{className:"btn-ghost",onClick:_,disabled:R===null,children:"Delete"}),a.jsx("button",{className:"btn-ghost",onClick:H,disabled:b.current.length===0,children:"Undo"})]})]})}export{te as default};
