import{r as i,j as t}from"./index-D_qvBJzx.js";import{p as x}from"./pdf-CB4NDRGm.js";import{E as re}from"./jspdf.es.min-CqRHn8ll.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";try{x.GlobalWorkerOptions.workerSrc=`//cdnjs.cloudflare.com/ajax/libs/pdf.js/${x.version}/pdf.worker.min.js`}catch(c){console.warn("pdfjs worker not set",c)}function oe(){const[c,q]=i.useState(null),[B,C]=i.useState(0),[R,U]=i.useState(!1),[V,k]=i.useState(!1),[A,I]=i.useState(!1),[v,Z]=i.useState(.7),[j,K]=i.useState(.9),[Q,G]=i.useState(null),[p,O]=i.useState(null),[o,b]=i.useState(null),[M,D]=i.useState(!1),[$,g]=i.useState(""),T=i.useRef(null),z=i.useRef(null),E=i.useRef(0),P=i.useRef(null);async function W(e){var n;const a=(n=e.target.files)==null?void 0:n[0];if(a){q(a),O(a.size);try{const s=await a.arrayBuffer();T.current=s;const d=await x.getDocument({data:s}).promise;z.current=d,C(d.numPages),b(null),g("")}catch(s){console.error(s),alert("Unable to read PDF: "+(s.message||s))}}}function _(e){e.preventDefault(),k(!0)}function H(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"}function X(e){e.preventDefault(),k(!1)}async function Y(e){var n,s;e.preventDefault(),k(!1);const a=(s=(n=e.dataTransfer)==null?void 0:n.files)==null?void 0:s[0];if(a){q(a),O(a.size);const d=await a.arrayBuffer(),r=await x.getDocument({data:d}).promise;C(r.numPages),b(null),g(""),I(!0),setTimeout(()=>I(!1),1500)}}function J(e){return e*25.4/96}async function L({download:e=!0,preview:a=!1}={download:!0,preview:!1}){if(!c)return alert("Select a PDF to compress");if(!(B>80&&!confirm("This PDF has "+B+" pages. Compressing will rasterize pages in the browser and may be slow or use lots of memory. Continue?"))){U(!0),G(null);try{const n=await c.arrayBuffer(),s=await x.getDocument({data:n}).promise,d=s.numPages;let r=null;for(let u=1;u<=d;u++){const m=await s.getPage(u),f=m.getViewport({scale:j}),l=document.createElement("canvas");l.width=Math.ceil(f.width),l.height=Math.ceil(f.height);const y=l.getContext("2d");await m.render({canvasContext:y,viewport:f}).promise;const h=l.toDataURL("image/jpeg",Number(v)),w=J(l.width),F=J(l.height);u===1?(r=new re({unit:"mm",format:[w,F]}),r.addImage(h,"JPEG",0,0,w,F)):(r.addPage([w,F]),r.addImage(h,"JPEG",0,0,w,F)),l.width=0,l.height=0}if(!r)throw new Error("Failed to create compressed PDF");if(a){const u=r.output("datauristring");G(u)}e&&r.save(c.name.replace(/\.pdf$/i,"")+"_compressed.pdf")}catch(n){console.error(n),alert("Compression failed: "+(n.message||n))}finally{U(!1)}}}async function ee(){if(!c)return alert("Select a PDF first");D(!0),b(null),g("Preparing...");try{const e=await c.arrayBuffer(),a=await x.getDocument({data:e}).promise,n=a.numPages;C(n),g("Rendering sample page...");const s=await a.getPage(1),d=s.getViewport({scale:j}),r=document.createElement("canvas");r.width=Math.ceil(d.width),r.height=Math.ceil(d.height);const u=r.getContext("2d");await s.render({canvasContext:u,viewport:d}).promise;const m=await new Promise(h=>r.toBlob(h,"image/jpeg",Number(v))),f=m?m.size:0,y=Math.max(0,Math.round(f*n+2e3));b(y),g("Estimated using sample page at current settings"),r.width=0,r.height=0}catch(e){console.error(e),alert("Estimate failed: "+(e.message||e))}finally{D(!1)}}async function N(e,a){const n=T.current||await c.arrayBuffer(),s=z.current||await x.getDocument({data:n}).promise,d=s.numPages,r=await s.getPage(1),u=r.getViewport({scale:a}),m=document.createElement("canvas");m.width=Math.ceil(u.width),m.height=Math.ceil(u.height);const f=m.getContext("2d");await r.render({canvasContext:f,viewport:u}).promise;const l=await new Promise(w=>m.toBlob(w,"image/jpeg",Number(e))),y=l?l.size:0,h=2e3;return m.width=0,m.height=0,Math.max(0,Math.round(y*d+h))}async function te(){if(!c)return alert("Select a PDF first");D(!0),g("Estimating range...");try{const e=T.current||await c.arrayBuffer(),a=z.current||await x.getDocument({data:e}).promise;T.current=e,z.current=a;const n=a.numPages;C(n);const s=.1,d=.5,r=1,u=1,m=Number(v),f=Number(j);g("Rendering low-quality sample...");const l=++E.current,y=await N(s,d);if(l!==E.current)throw new Error("Cancelled");g("Rendering current settings sample...");const h=await N(m,f);if(l!==E.current)throw new Error("Cancelled");g("Rendering high-quality sample...");const w=await N(r,u);if(l!==E.current)throw new Error("Cancelled");b({low:y,cur:h,high:w}),g("Range estimated using first-page extrapolation")}catch(e){console.error(e),alert("Range estimate failed: "+(e.message||e))}finally{D(!1)}}i.useEffect(()=>{if(c)return P.current&&clearTimeout(P.current),P.current=setTimeout(()=>{(E.current++)(async()=>{try{D(!0),g("Estimating...");const e=await N(Number(v),Number(j));if(E.current===0)return;b({cur:e}),g("Live estimate updated")}catch(e){e.message!=="Cancelled"&&console.error(e)}finally{D(!1)}})()},350),()=>{P.current&&clearTimeout(P.current)}},[c,v,j]);function S(e){return e==null?"-":e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(2)+" MB"}return t.jsxs("div",{children:[t.jsx("h2",{children:"Compress PDF"}),t.jsxs("div",{className:`dropzone ${V?"dragover":""}`,onDragEnter:_,onDragOver:H,onDragLeave:X,onDrop:Y,children:[t.jsx("input",{type:"file",accept:"application/pdf",onChange:W}),t.jsx("div",{className:"muted",children:"Rasterize pages at lower quality/scale to reduce file size (lossy)."}),A&&t.jsx("div",{className:"drop-overlay",children:"✓ Uploaded"})]}),c&&t.jsxs("div",{style:{marginTop:12},children:[t.jsxs("div",{children:[t.jsx("strong",{children:c.name})," — ",B," pages — original: ",S(p)]}),o&&t.jsxs("div",{style:{marginTop:8},children:[typeof o=="number"&&t.jsxs("div",{children:["Estimated compressed size: ",t.jsx("strong",{children:S(o)})," (",p?Math.round(100-o/p*100):0,"% smaller)"]}),typeof o=="object"&&t.jsx("div",{children:o.low&&o.cur&&o.high?t.jsxs(t.Fragment,{children:[t.jsx("div",{children:"Estimated range:"}),t.jsxs("div",{style:{display:"flex",gap:12,marginTop:6},children:[t.jsxs("div",{children:["Min: ",t.jsx("strong",{children:S(o.low)})," (",p?Math.round(100-o.low/p*100):0,"% smaller)"]}),t.jsxs("div",{children:["Current: ",t.jsx("strong",{children:S(o.cur)})," (",p?Math.round(100-o.cur/p*100):0,"% smaller)"]}),t.jsxs("div",{children:["Max: ",t.jsx("strong",{children:S(o.high)})," (",p?Math.round(100-o.high/p*100):0,"% smaller)"]})]})]}):t.jsxs("div",{children:["Estimated compressed size (live): ",t.jsx("strong",{children:S(o.cur)})," ",p?`(${Math.round(100-o.cur/p*100)}% smaller)`:""]})})]}),$&&t.jsx("div",{style:{marginTop:8,color:"#6b7280"},children:$}),t.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center",marginTop:8},children:[t.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center"},children:["JPEG Quality:",t.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:v,onChange:e=>Z(Number(e.target.value))}),t.jsxs("div",{style:{width:44,textAlign:"right"},children:[Math.round(v*100),"%"]})]}),t.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center"},children:["Render Scale:",t.jsxs("select",{value:j,onChange:e=>K(Number(e.target.value)),children:[t.jsx("option",{value:1,children:"100%"}),t.jsx("option",{value:.9,children:"90%"}),t.jsx("option",{value:.8,children:"80%"}),t.jsx("option",{value:.7,children:"70%"}),t.jsx("option",{value:.6,children:"60%"}),t.jsx("option",{value:.5,children:"50%"})]})]})]}),t.jsxs("div",{style:{marginTop:12,display:"flex",gap:8},children:[t.jsx("button",{className:"btn-primary",onClick:()=>L({download:!0,preview:!1}),disabled:R,children:R?"Compressing...":"Compress & Download"}),t.jsx("button",{className:"btn-outline",onClick:()=>L({download:!1,preview:!0}),disabled:R,children:R?"Compressing...":"Preview"}),t.jsx("button",{className:"btn-ghost",onClick:ee,disabled:M,children:M?"Estimating...":"Estimate size"}),t.jsx("button",{className:"btn-ghost",onClick:te,disabled:M,children:M?"Estimating...":"Estimate range (min/cur/max)"})]}),Q&&t.jsxs("div",{style:{marginTop:12},children:[t.jsx("div",{className:"muted",children:"Preview (close tab/window to dismiss):"}),t.jsx("iframe",{title:"compress-preview",src:Q,style:{width:"100%",height:400,border:"1px solid #ddd"}})]})]})]})}export{oe as default};
